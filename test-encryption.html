<!DOCTYPE html>
<html>
<head>
    <title>Test Encryption</title>
</head>
<body>
    <h1>Test Encryption</h1>
    <button onclick="testEncryption()">Test Encryption</button>
    <pre id="output"></pre>

    <script>
        async function testEncryption() {
            const output = document.getElementById('output');
            output.textContent = 'Testing...\n';

            try {
                // Test 1: Check if crypto is available
                output.textContent += '? crypto.subtle available: ' + (!!crypto.subtle) + '\n';

                // Test 2: Generate random values
                const salt = crypto.getRandomValues(new Uint8Array(16));
                output.textContent += '? Generated salt: ' + salt.length + ' bytes\n';

                // Test 3: Generate key
                const encoder = new TextEncoder();
                const password = 'test-password-123';
                const passwordBuffer = encoder.encode(password);
                
                const keyMaterial = await crypto.subtle.importKey(
                    'raw',
                    passwordBuffer,
                    'PBKDF2',
                    false,
                    ['deriveKey']
                );
                output.textContent += '? Imported key material\n';

                const key = await crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt: salt,
                        iterations: 100000,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 },
                    false,
                    ['encrypt', 'decrypt']
                );
                output.textContent += '? Derived encryption key\n';

                // Test 4: Encrypt data
                const testData = { test: 'Hello World!' };
                const dataString = JSON.stringify(testData);
                const dataBuffer = encoder.encode(dataString);
                const iv = crypto.getRandomValues(new Uint8Array(12));

                const encryptedBuffer = await crypto.subtle.encrypt(
                    {
                        name: 'AES-GCM',
                        iv: iv
                    },
                    key,
                    dataBuffer
                );
                output.textContent += '? Encrypted data: ' + encryptedBuffer.byteLength + ' bytes\n';

                // Test 5: Decrypt data
                const decryptedBuffer = await crypto.subtle.decrypt(
                    {
                        name: 'AES-GCM',
                        iv: iv
                    },
                    key,
                    encryptedBuffer
                );
                const decoder = new TextDecoder();
                const decryptedString = decoder.decode(decryptedBuffer);
                const decryptedData = JSON.parse(decryptedString);
                output.textContent += '? Decrypted data: ' + JSON.stringify(decryptedData) + '\n';

                output.textContent += '\n? ALL TESTS PASSED!\n';

            } catch (error) {
                output.textContent += '\n? ERROR: ' + error.message + '\n';
                output.textContent += 'Stack: ' + error.stack + '\n';
            }
        }
    </script>
</body>
</html>
